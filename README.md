# LinDream - QQ机器人框架

## 🎉 LinDream V1.0.2 更新内容

### 新增功能
- **引用消息AI聊天**：支持引用消息后使用`%`前缀触发AI聊天，AI会自然地回应引用内容
- **引用图片支持**：引用消息中的图片可一并提交给AI进行处理
- **人格记忆功能**：机器人会记住关机前的人格设置，重启后自动恢复之前的人格
- **人格显示修复**：修复了`/persona`命令显示当前人格不准确的问题，现在能正确显示群聊和私聊中当前使用的人格

### 功能优化
- **人格切换改进**：修复群聊中切换人格不生效的问题，现在群聊和私聊人格管理更加独立准确
- **私聊响应优化**：提高补丁在私聊中的响应概率，使用更积极的回复策略
- **AI交互自然度**：优化AI对引用消息的处理，生成更自然的回复如"XXX说的很对呢"

### 问题修复
- **群聊人格管理**：修复群聊中切换人格时会话历史未正确清除的问题
- **消息解析优化**：改进对复杂消息结构（包含文本、图片、引用）的解析处理

### 架构改进
- **会话管理独立化**：群聊和私聊会话管理更加独立，避免相互干扰
- **消息处理逻辑**：重构消息处理流程，提高代码可读性和维护性

---

## 📋 项目介绍

LinDream是一个基于Python开发的QQ机器人框架，采用WebSocket协议与OneBot协议兼容的QQ机器人平台（如go-cqhttp）进行通信。项目具有插件化架构，支持自动回复、AI聊天、媒体文件下载、权限管理等功能。

## ✨ 核心功能

### 🤖 基础功能
- **消息收发**：支持群聊和私聊消息处理
- **自动回复**：关键词触发自动回复功能
- **随机回复**：被@时随机选择回复内容
- **媒体文件下载**：自动下载群聊中的图片和视频文件
- **消息防撤回**：记录消息内容，防止撤回
- **会话管理**：用户和群聊的独立会话历史

### 🧠 AI聊天功能
- **智能对话**：集成主流AI API（支持自定义API地址和模型）
- **人格切换**：支持多种AI人格配置
- **上下文记忆**：保持对话历史，提供连贯的对话体验
- **触发方式**：支持`%`前缀或直接@机器人触发

### 🔧 插件系统
- **动态加载**：支持运行时加载和卸载插件
- **插件管理**：通过指令查看和管理插件
- **自定义触发**：插件可定义自己的触发指令
- **事件处理**：插件可处理各类消息事件

### 👥 权限管理
- **多级权限**：主人(3)、管理员(2)、用户(1)三级权限
- **动态授权**：支持运行时添加/移除管理员
- **指令权限**：不同权限等级可执行不同指令

### ⚙️ 配置管理
- **配置文件**：JSON格式配置，支持API密钥、权限设置等
- **热重载**：支持运行时重载配置和插件
- **人格文件**：TXT格式人格定义，可自定义AI行为

## 🚀 部署教程

### 环境要求
- Python 3.8+
- OneBot协议兼容的QQ机器人平台
### 方案一:一键脚本！使用一键脚本部署NapCat和LinDream
```bash
curl -L -o LinDreamInstall.sh https://raw.githubusercontent.com/DXBbyd/LinDreamInstall/main/LinDreamInstall.sh && bash LinDreamInstall.sh
```
### 方案二:git克隆部署
### 1. 克隆项目(默认使用镜像加速)
```bash
git clone http://github.fufumc.top/https://github.com/DXBbyd/LinDream.git
cd LinDream
```

### 2. 安装uv包管理器,创建虚拟环境，并进入
```bash
uv venv
source .venv/bin/activate
```

### 3. 安装依赖
```bash
uv pip install -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple
```
### 4.配置消息平台（NapCat）
详细安装方式请参见→napcat.wiki
在WebUI中设置ws反向代理连接地址为ws://127.0.01:2048，不配置token。即可

### 5. 配置机器人
应该是不需要手动创建的，因为首次启动会询问你的哦~
(这个版本的配置文件已经是旧的了！首次启动会通过交互配置所以不需要看这个）创建 `config.json` 文件：
```json
{
    "api_key": "your_ai_api_key",
    "api_url": "https://apis.iflow.cn/v1/chat/completions",
    "model_name": "qwen3-coder-plus",
    "owner_id": "你的QQ号",
    "admins": ["管理员QQ号1", "管理员QQ号2"],
    "users": ["用户QQ号1", "用户QQ号2"]
}
```

### 6. 配置自动回复
下面是自动回复格式，一行一个配置
```
关键词1 回复内容1
关键词2 回复内容2
```

### 7. 配置随机回复
这个是戳一戳的随机回复
```
随机回复内容1
随机回复内容2
随机回复内容3
```

### 8. 配置人格（可选）
在 `persona/` 目录下创建人格文件，如 `default.txt`：
```
你是一个友好的AI助手，乐于助人且回答简洁明了。
```

### 9. 启动机器人
```bash
python main.py
```

## 📖 使用说明

### 基础指令
- `/help` - 显示帮助信息
- `/limit` - 查看当前权限等级
- `/plugin` - 显示已加载的插件列表
- `/persona ls` - 列出所有人格
- `/persona <名称>` - 切换人格
- `/reset` - 重载配置和插件（管理员以上权限）

### AI聊天
- 在群聊中@机器人并输入消息
- 或使用 `%` 前缀：`%你好，请自我介绍`

### 插件使用
- 查看插件列表：`/plugin`
- 插件具体使用方法请查看各插件说明

## 📁 项目结构
```
LinDream/
├── main.py              # 主程序
├── requirements.txt     # 依赖列表
├── config.json         # 配置文件（需自建）
├── auto.txt            # 自动回复规则（需自建）
├── random.txt          # 随机回复内容（需自建）
├── message_log.txt     # 消息日志（自动生成）
├── persona/            # 人格配置目录
│   └── default.txt     # 默认人格
├── plugin/             # 插件目录
│
└── file/               # 下载文件存储
    ├── picture/        # 图片文件
    └── video/          # 视频文件（仅缓存10分钟）
```

## 🔧 高级配置

### API配置
支持自定义AI服务提供商，配置格式：
```json
{
    "api_key": "your_api_key",
    "api_url": "https://your-api-endpoint.com/v1/chat/completions",
    "model_name": "your-model-name"
}
```

### 权限系统
- **主人权限**：可以执行所有指令，管理管理员
- **管理员权限**：可以重载配置，协助管理
- **用户权限**：可以使用基础功能和AI聊天

### 插件开发
插件需要实现以下函数之一：
- `on_message(websocket, data, bot_id)` - 处理消息
- `on_command(websocket, data, command, bot_id)` - 处理指令
- `on_load()` - 插件加载时调用

## 📝 注意事项

1. **安全性**：请妥善保管API密钥和配置文件
2. **性能**：建议设置适当的下载线程数和消息缓存大小
3. **合规性**：使用机器人时请遵守相关平台规定
4. **稳定性**：建议定期清理下载的文件和日志

## 🤝 贡献

欢迎提交Issue和Pull Request来改进项目！

## 📄 许可证

本项目采用MIT许可证 - 详见LICENSE文件
## 结语
欢迎去B站找我反馈bug，或者去我的视频下面提插件的建议，合理的话我一定会写的！！！
UP的B站，直接搜名字就能搜到哦，一定要点用户哦！UP的名字:软白from
你的三连就是我坚持的动力喵！
